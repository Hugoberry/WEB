using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;
using Iserv.Niis.DataAccess.EntityFramework;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using RestSharp.Extensions;

namespace Iserv.Niis.Portal.Infrastructure.InitialData
{
    public static partial class InitialDataSeed
    {
        private static async Task SeedDocumentTemplateFiles(this IApplicationBuilder app)
        {
            var context = app.ApplicationServices.GetService<NiisWebContext>();
            var hostingEnvironment = app.ApplicationServices.GetService<IHostingEnvironment>();
            //key: название шаблона value: идентификатор самого шаблона (указан в типе документа)
            var templateEntities = new Dictionary<string, int>
            {
                {"Приложение 1", 396},
                {"Приложение 2", 5110},
                {"Приложение 3", 335},
                {"Приложение 4", 113},
                {"Приложение 5", 77},
                {"Приложение 6", 81},
                {"Приложение 7", 188},
                {"Приложение 8", 78},
                {"Приложение 9", 84},
                {"Приложение 10", 72},
                {"Приложение 11", 73},
                {"Приложение 12", 79},
                {"Приложение 13", 47},
                {"Приложение 14", 48},
                {"Приложение 15", 49},
                {"Приложение 16", 29},
                {"Приложение 18", 37},
                {"Приложение 19", 36},
                {"Приложение 20", 7},
                {"Приложение 21", 63},
                {"Приложение 22", 61},
                {"Приложение 23", 65},
                {"Приложение 24", 62},
                {"Приложение 25", 64},
                {"Приложение 26", 60},
                {"Приложение 27", 201},
                {"Приложение 28", 165},
                {"Приложение 30", 4},
                {"Приложение 33", 5078},
                {"Приложение 34", 5118},
                {"Приложение 35", 164},
                {"Приложение 36", 5119},
                {"Приложение 38", 3},
                {"Приложение 39", 5054},
                {"Приложение 40", 5052},
                {"Приложение 41", 189},
                {"Приложение 42", 5120},
                {"Приложение 43", 67},
                {"Приложение 44", 66},
                {"Приложение 46", 312},
                {"Приложение 47", 34},
                {"Приложение 48", 32},
                {"Приложение 49", 27},
                {"Приложение 50", 5134},
                {"Приложение 51", 5136},
                {"Приложение 54", 111},
                {"Приложение 55", 23},
                {"Приложение 56", 5122},
                {"Приложение 57", 5121},
                {"Приложение 58", 5127},
                {"Приложение 59", 105},
                {"Приложение 60", 5067},
                {"Приложение 61", 143},
                {"Приложение 62", 284},
                {"Приложение 63", 5069},
                {"Приложение 64", 291},
                {"Приложение 65", 234},
                {"Приложение 66", 5065},
                {"Приложение 67", 215},
                {"Приложение 68", 5079},
                {"Приложение 69", 5062},
                {"Приложение 70", 216},
                {"Приложение 71", 203},
                {"Приложение 72", 144},
                {"Приложение 73", 146},
                {"Приложение 74", 26},
                {"Приложение 75", 210},
                {"Приложение 76", 5112},
                {"Приложение 77", 271},
                {"Приложение 78", 265},
                {"Приложение 79", 266},
                {"Приложение 80", 317},
                {"Приложение 81", 5061},
                {"Приложение 82", 5057},
                {"Приложение 83", 5055},
                {"Приложение 84", 264},
                {"Приложение 85", 5059},
                {"Приложение 102", 25},
                {"Приложение 106", 339},
                {"Приложение 152", 69},
                {"Приложение 153", 288},
                {"Приложение 154", 259},
                {"Приложение 155", 5092},
                {"Приложение 156", 258},
                {"Приложение 157", 76},
                {"Приложение 158", 332},
                {"Приложение 159", 337},
                {"Приложение 162", 149},
                {"Приложение 163", 151},
                {"Приложение 164", 150},
                {"Приложение 165", 360},
                {"Приложение 169", 205},
                {"Приложение 170", 102},
                {"Приложение 171", 208},
                {"Приложение 172", 1},
                {"Приложение 173", 194},
                {"Приложение 174", 19},
                {"Приложение 175", 249},
                {"Приложение 176", 14},
                {"Приложение 177", 74},
                {"Приложение 178", 289},
                {"Приложение 179", 70},
                {"Приложение 180", 71},
                {"Приложение 196", 186},
                {"Приложение 198", 5085},
                {"Приложение 199", 318},
                {"Приложение 201", 304},
                {"Приложение 202", 301},
                {"Приложение 220", 382},
                {"Приложение 243", 5064},
                {"Приложение 261", 5066},
                {"Приложение 272", 166},
                {"Приложение 275", 362},
                {"Приложение 309", 393},
                {"Приложение 311", 240},
                {"Приложение 312", 325},
                {"Приложение 314", 388},
                {"Приложение 315", 225},
                {"Приложение 316", 250},
                {"Приложение 317", 251},
                {"Приложение 318", 224},
                {"Приложение 319", 394},
                {"Приложение 320", 5077},
                {"Приложение 321", 190},
                {"Приложение 322", 299},
                {"Приложение 323", 236},
                {"Приложение 324", 237},
                {"Приложение 325", 238},
                {"Приложение 326", 239},
                {"Приложение 327", 324},
                {"Приложение 328", 283},
                {"Приложение 329", 302},
                {"Приложение 330", 331},
                {"Приложение 331", 315},
                {"Приложение 332", 314},
                {"Приложение 333", 268},
                {"Приложение 334", 303},
                {"Приложение 335", 269},
                {"Приложение 336", 270},
                {"Приложение 337", 255},
                {"Приложение 338", 256},
                {"Приложение 339", 218},
                {"Приложение 341", 257},
                {"Приложение 343", 384},
                {"Приложение 345", 385},
                {"Приложение 353", 156},
                {"Приложение 355", 365},
                {"Приложение 370", 356 },
                {"Приложение 371", 5141 },
                {"Приложение 372", 5140 },
                {"Приложение 373", 5137 },
                {"Приложение 374", 5138 },
                {"Приложение 375", 5139 },
                {"Приложение 382", 341},
                {"Приложение 386", 187},
                {"Приложение 387", 217},
                {"Приложение 389", 387},
                {"Приложение 390", 333},
                {"Приложение 391", 260},
                {"Приложение 392", 374},
                {"Приложение 393", 383},
                {"Приложение 400", 398},
                {"Приложение 401", 359},
                {"Приложение 402", 5068},
                {"Приложение 403", 267},
                {"Приложение 404", 5093},
                {"Приложение 405", 5096},
                {"Приложение 406", 5097},
                {"Приложение 415", 59},
                {"Приложение 416", 287},
                {"Приложение 417", 372},
                {"Приложение 418", 28},
                {"Приложение 419", 5116},
                {"Приложение 422", 311},
                {"Приложение 423", 5075},
                {"Приложение 425", 327},
                {"Приложение 426", 326},
                {"Приложение 428", 329},
                {"Приложение 429", 235},
                {"Приложение 431", 109},
                {"Приложение 432", 5076},
                {"Приложение 433", 214},
                {"Приложение 434", 211},
                {"Приложение 435", 58},
                {"Приложение 437", 183},
                {"Приложение 438", 98},
                {"Приложение 441", 24},
                {"Приложение 442", 320},
                {"Приложение 443", 9},
                {"Приложение 444", 247},
                {"Приложение 445", 68},
                {"Приложение 446", 5074},
                {"Приложение 447", 243},
                {"Приложение 448", 89},
                {"Приложение 451", 5072},
                {"Приложение 452", 322},
                {"Приложение 453", 91},
                {"Приложение 454", 88},
                {"Приложение 455", 361},
                {"Приложение 456", 158},
                {"Приложение 457", 45},
                {"Приложение 458", 5117},
                {"Приложение 459", 345},
                {"Приложение 460", 292},
                {"Приложение 461", 373},
                {"Приложение 462", 104},
                {"Приложение 463", 159},
                {"Приложение 464", 41},
                {"Приложение 465", 145},
                {"Приложение 466", 18},
                {"Приложение 467", 17},
                {"Приложение 468", 319},
                {"Приложение 469", 244},
                {"Приложение 470", 15},
                {"Приложение 471", 246},
                {"Приложение 472", 103},
                {"Приложение 473", 50},
                {"Приложение 474", 16},
                {"Приложение 475", 5051},
                {"Приложение 476", 245},
                {"Приложение 477", 46},
                {"Приложение 478", 51},
                {"Приложение 479", 52},
                {"Приложение 480", 53},
                {"Приложение 481", 298},
                {"Приложение 482", 8},
                {"Приложение 483", 5053},
                {"Приложение 484", 43},
                {"Приложение 485", 93},
                {"Приложение 488", 5073},
                {"Приложение 489", 95},
                {"Приложение 490", 182},
                {"Приложение 491", 181},
                {"Приложение 492", 42},
                {"Приложение 494", 397},
                {"Приложение 495", 389},
                {"Приложение 496", 316},
                {"Приложение 497", 33},
                {"Приложение 499", 390},
                {"Приложение 501", 294},
                {"Приложение 502", 39},
                {"Приложение 503", 30},
                {"Приложение 500", 313},
                {"Приложение 504", 57},
                {"Приложение 505", 286},
                {"Приложение 506", 5},
                {"Приложение 507", 31},
                {"Приложение 508", 35},
                {"Приложение 510", 5070},
                {"Приложение 511", 212},
                {"Приложение 512", 248},
                {"Приложение 513", 1849},
                {"Приложение 514", 5115},
                {"Приложение 515", 209},
                {"Приложение 516", 346},
                {"Приложение 536", 75},
                {"Приложение 537", 366},
                {"Приложение 539", 82},
                {"Приложение 540", 83},
                {"Приложение 542", 85},
                {"Приложение 543", 86},
                {"Приложение 544", 5060},
                {"Приложение 545", 54},
                {"Приложение 546", 55},
                {"Приложение 547", 56},
                {"Приложение 576", 358},
                {"Приложение 577", 357},
                {"Приложение 578", 195},
                {"Приложение 579", 386},
                {"Приложение 580", 12},
                {"Приложение 581", 1853},
                {"Приложение 582", 2},
                {"Приложение 583", 309},
                {"Приложение 584", 22},
                {"Приложение 585", 196},
                {"Приложение 586", 355},
                {"Приложение 587", 20},
                {"Приложение 588", 310},
                {"Приложение 589", 11},
                {"Приложение 590", 399},
                {"Приложение 591", 363},
                {"Приложение 592", 261},
                {"Приложение 593", 330},
                {"Приложение 594", 21},
                {"Приложение 595", 6},
                {"Приложение 596", 5058}
            };

            await UpdateTemplates(templateEntities, "Resources/DocumentTemplates", context, hostingEnvironment);

            var conclusionEntities = new Dictionary<string, int>
            {
                // template file name / template id
                {"ExpertConclusionByRequest", 128},
                {"InventionExpertSearchReport", 405 }
            };

            await UpdateTemplates(conclusionEntities, "Resources/ConclusionTemplates", context, hostingEnvironment);

            await context.SaveChangesAsync();
        }

        private static async Task UpdateTemplates(
            Dictionary<string, int> templateEntities,
            string templatesRootPath,
            NiisWebContext context,
            IHostingEnvironment hostingEnvironment)
        {

            foreach (var template in templateEntities)
            {
                var dbTemplate = await context.DocumentTemplateFiles.SingleAsync(x => x.Id == template.Value);

                var fileInfo = hostingEnvironment.ContentRootFileProvider
                    .GetFileInfo(Path.Combine(templatesRootPath, $"{template.Key}.docx"));

                if (fileInfo.LastModified < DateTimeOffset.Now.AddDays(-7))
                {
                    return;
                }

                var fileBytes = fileInfo
                    .CreateReadStream()
                    .ReadAsBytes();

                dbTemplate.File = fileBytes;
                dbTemplate.FileType = "application/vnd.openxmlformats-officedocument.wordprocessingml.document";
                dbTemplate.FileName = dbTemplate.FileName.Replace(".odt", ".docx");

                context.DocumentTemplateFiles.Update(dbTemplate);
            }
        }
    }
}